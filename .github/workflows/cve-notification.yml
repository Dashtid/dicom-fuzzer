name: CVE Notification & Dependency Security

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  push:
    branches: [main]
    paths:
      - 'pyproject.toml'
      - 'uv.lock'
  pull_request:
    branches: [main]
    paths:
      - 'pyproject.toml'
      - 'uv.lock'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install scanning tools
        run: |
          pip install pip-audit safety

      - name: Run pip-audit
        id: pip-audit
        continue-on-error: true
        run: |
          pip-audit --format=json --output=pip-audit-results.json 2>&1 || true
          pip-audit --format=markdown --output=pip-audit-results.md 2>&1 || true

          # Check for vulnerabilities
          if [ -f pip-audit-results.json ]; then
            VULN_COUNT=$(jq 'length' pip-audit-results.json 2>/dev/null || echo "0")
            echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT
          else
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Run Safety check
        id: safety
        continue-on-error: true
        run: |
          safety check --json > safety-results.json 2>&1 || true

      - name: Generate combined report
        id: report
        run: |
          echo "## Dependency Security Scan Results" > security-report.md
          echo "" >> security-report.md
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> security-report.md
          echo "" >> security-report.md

          # pip-audit results
          echo "### pip-audit Results" >> security-report.md
          if [ -f pip-audit-results.md ]; then
            cat pip-audit-results.md >> security-report.md
          else
            echo "No vulnerabilities found by pip-audit." >> security-report.md
          fi
          echo "" >> security-report.md

          # Safety results
          echo "### Safety Results" >> security-report.md
          if [ -f safety-results.json ]; then
            jq -r '.vulnerabilities[]? | "- **\(.package_name)** \(.vulnerable_versions): \(.vulnerability_id) - \(.advisory)"' safety-results.json >> security-report.md 2>/dev/null || echo "No vulnerabilities found by Safety." >> security-report.md
          else
            echo "No vulnerabilities found by Safety." >> security-report.md
          fi

          cat security-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            pip-audit-results.json
            pip-audit-results.md
            safety-results.json
            security-report.md
          retention-days: 90

      - name: Create/Update security issue
        if: steps.pip-audit.outputs.vulnerability_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the security report
            let report = '';
            try {
              report = fs.readFileSync('security-report.md', 'utf8');
            } catch (e) {
              report = 'Failed to read security report';
            }

            const vulnCount = '${{ steps.pip-audit.outputs.vulnerability_count }}';
            const title = `[Security] ${vulnCount} dependency vulnerabilities found`;

            // Check for existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies',
              per_page: 10
            });

            const existingIssue = issues.find(i => i.title.includes('dependency vulnerabilities'));

            const body = `## Automated Security Scan

            This issue was automatically created/updated by the CVE notification workflow.

            ${report}

            ### Action Required

            1. Review the vulnerabilities listed above
            2. Update affected dependencies to patched versions
            3. If no patch available, assess risk and document mitigation

            ### References

            - [pip-audit documentation](https://pypi.org/project/pip-audit/)
            - [NVD CVE Database](https://nvd.nist.gov/)
            - [GitHub Advisory Database](https://github.com/advisories)

            ---
            *Last updated: ${new Date().toISOString()}*
            `;

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'dependencies', 'automated']
              });
              console.log('Created new security issue');
            }

  dicom-cve-check:
    name: DICOM-specific CVE Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for DICOM-related CVEs
        id: dicom-cves
        run: |
          echo "## DICOM-Related CVE Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Known DICOM-related packages to monitor
          PACKAGES=("pydicom" "pynetdicom" "gdcm" "pillow" "numpy")

          echo "### Monitored Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for pkg in "${PACKAGES[@]}"; do
            echo "- $pkg" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recent DICOM CVEs (2025)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| CVE ID | Product | CVSS | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| CVE-2025-5943 | MicroDicom | 8.8 | Out-of-bounds write |" >> $GITHUB_STEP_SUMMARY
          echo "| CVE-2025-53618 | GDCM | 7.5 | OOB read in JPEG codec |" >> $GITHUB_STEP_SUMMARY
          echo "| CVE-2025-53619 | GDCM | 7.5 | OOB read in JPEG codec |" >> $GITHUB_STEP_SUMMARY
          echo "| CVE-2025-52582 | GDCM | N/A | Information leak |" >> $GITHUB_STEP_SUMMARY
          echo "| CVE-2025-11266 | GDCM | 6.6 | PixelData OOB write |" >> $GITHUB_STEP_SUMMARY

      - name: Update CVE patterns
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Patterns Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if security_patterns.py includes recent CVEs
          if grep -q "CVE-2025" dicom_fuzzer/strategies/security_patterns.py 2>/dev/null; then
            echo "[+] CVE-2025 patterns found in security_patterns.py" >> $GITHUB_STEP_SUMMARY
          else
            echo "[-] CVE-2025 patterns may need to be added" >> $GITHUB_STEP_SUMMARY
          fi
