name: Fuzzing Pipeline

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'dicom_fuzzer/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
  push:
    branches: [main]
    paths:
      - 'dicom_fuzzer/**'
  schedule:
    # Nightly fuzzing at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      fuzz_duration:
        description: 'Fuzzing duration in seconds'
        required: false
        default: '600'
        type: string
      fuzz_iterations:
        description: 'Number of fuzzing iterations'
        required: false
        default: '10000'
        type: string

permissions:
  contents: read
  pull-requests: write
  actions: read

env:
  # PR fuzzing: 10 minutes (per ClusterFuzzLite/FDA best practices)
  PR_FUZZ_DURATION: 600
  PR_FUZZ_ITERATIONS: 10000
  # Nightly fuzzing: 8 hours (FDA recommendation)
  NIGHTLY_FUZZ_DURATION: 28800
  NIGHTLY_FUZZ_ITERATIONS: 1000000

jobs:
  # Quick smoke test for PRs - validates sample generators work
  pr-sample-validation:
    name: Sample Generation Smoke Test
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Install uv
        uses: astral-sh/setup-uv@374b9305c53f17cee51e793c1234cdb1897489d5  # v7
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Generate CVE replication samples
        run: |
          mkdir -p ./test_samples

          # Create a template DICOM file for CVE generation
          uv run python -c "
          import pydicom
          from pydicom.dataset import Dataset, FileMetaDataset
          from pydicom.uid import generate_uid, ImplicitVRLittleEndian
          file_meta = FileMetaDataset()
          file_meta.TransferSyntaxUID = ImplicitVRLittleEndian
          file_meta.MediaStorageSOPClassUID = '1.2.840.10008.5.1.4.1.1.2'
          file_meta.MediaStorageSOPInstanceUID = generate_uid()
          file_meta.ImplementationClassUID = generate_uid()
          ds = Dataset()
          ds.file_meta = file_meta
          ds.is_implicit_VR = True
          ds.is_little_endian = True
          ds.PatientName = 'CI^Template'
          ds.PatientID = 'CI001'
          ds.Modality = 'CT'
          ds.Rows = 64
          ds.Columns = 64
          ds.BitsAllocated = 16
          ds.BitsStored = 16
          ds.HighBit = 15
          ds.SamplesPerPixel = 1
          ds.PixelRepresentation = 0
          ds.PhotometricInterpretation = 'MONOCHROME2'
          ds.PixelData = b'\x00' * (64 * 64 * 2)
          ds.save_as('./template.dcm', enforce_file_format=True)
          print('[+] Template created')
          "

          # Generate CVE replication files
          uv run dicom-fuzzer cve --all -t ./template.dcm -o ./test_samples
        timeout-minutes: 5

      - name: Validate generated samples
        run: |
          echo "[i] Checking generated samples..."
          find ./test_samples -name "*.dcm" | head -20
          SAMPLE_COUNT=$(find ./test_samples -name "*.dcm" | wc -l)
          echo "[+] Generated $SAMPLE_COUNT DICOM samples"
          if [ "$SAMPLE_COUNT" -lt 10 ]; then
            echo "[-] FAIL: Expected at least 10 samples, got $SAMPLE_COUNT"
            exit 1
          fi
          echo "[+] Sample generation validated"

      - name: Validate CVE listing
        run: |
          uv run dicom-fuzzer cve --list
          echo "[+] CVE listing validated"

      - name: Upload sample artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v5
        if: always()
        with:
          name: pr-sample-validation
          path: ./test_samples/
          retention-days: 7

  # PR fuzzing - quick validation
  pr-fuzzing:
    name: PR Fuzzing (10 min)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Install uv
        uses: astral-sh/setup-uv@374b9305c53f17cee51e793c1234cdb1897489d5  # v7
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Download corpus (if available)
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb  # v4
        with:
          path: ./corpus
          key: fuzz-corpus-${{ github.base_ref }}-${{ hashFiles('dicom_fuzzer/**') }}
          restore-keys: |
            fuzz-corpus-${{ github.base_ref }}-
            fuzz-corpus-main-

      - name: Run PR fuzzing campaign
        run: |
          mkdir -p ./corpus ./crashes ./output

          echo "[i] Starting PR fuzzing campaign..."

          # Create a template DICOM file
          uv run python -c "
          import pydicom
          from pydicom.dataset import Dataset, FileMetaDataset
          from pydicom.uid import generate_uid, ImplicitVRLittleEndian
          file_meta = FileMetaDataset()
          file_meta.TransferSyntaxUID = ImplicitVRLittleEndian
          file_meta.MediaStorageSOPClassUID = '1.2.840.10008.5.1.4.1.1.2'
          file_meta.MediaStorageSOPInstanceUID = generate_uid()
          file_meta.ImplementationClassUID = generate_uid()
          ds = Dataset()
          ds.file_meta = file_meta
          ds.is_implicit_VR = True
          ds.is_little_endian = True
          ds.PatientName = 'CI^Template'
          ds.PatientID = 'CI001'
          ds.Modality = 'CT'
          ds.Rows = 64
          ds.Columns = 64
          ds.BitsAllocated = 16
          ds.BitsStored = 16
          ds.HighBit = 15
          ds.SamplesPerPixel = 1
          ds.PixelRepresentation = 0
          ds.PhotometricInterpretation = 'MONOCHROME2'
          ds.PixelData = b'\x00' * (64 * 64 * 2)
          ds.save_as('./corpus/template.dcm', enforce_file_format=True)
          print('[+] Template created')
          "

          # Run mutation-based fuzzing
          uv run dicom-fuzzer ./corpus/template.dcm \
            -c ${{ env.PR_FUZZ_ITERATIONS }} \
            -o ./output \
            2>&1 | tee fuzz_output.log || true

          echo "[+] Fuzzing completed"
        timeout-minutes: 20

      - name: Check for crashes
        run: |
          CRASH_COUNT=$(find ./crashes -type f 2>/dev/null | wc -l)
          echo "[i] Found $CRASH_COUNT crash samples"

          if [ "$CRASH_COUNT" -gt 0 ]; then
            echo "[!] WARN: Crashes detected during fuzzing"
            ls -la ./crashes/
            # Don't fail PR for crashes - they're expected in security testing
          fi

      - name: Upload fuzzing results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v5
        if: always()
        with:
          name: pr-fuzzing-results
          path: |
            ./crashes/
            ./output/
            fuzz_output.log
          retention-days: 7

  # Nightly comprehensive fuzzing
  nightly-fuzzing:
    name: Nightly Fuzzing (8 hours)
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.fuzz_duration)
    runs-on: ubuntu-latest
    timeout-minutes: 500  # ~8.3 hours
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Install uv
        uses: astral-sh/setup-uv@374b9305c53f17cee51e793c1234cdb1897489d5  # v7
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Download corpus cache
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb  # v4
        with:
          path: ./corpus
          key: fuzz-corpus-nightly-${{ github.run_number }}
          restore-keys: |
            fuzz-corpus-nightly-
            fuzz-corpus-main-

      - name: Set fuzzing parameters
        id: params
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_DURATION: ${{ github.event.inputs.fuzz_duration }}
          INPUT_ITERATIONS: ${{ github.event.inputs.fuzz_iterations }}
          DEFAULT_DURATION: ${{ env.NIGHTLY_FUZZ_DURATION }}
          DEFAULT_ITERATIONS: ${{ env.NIGHTLY_FUZZ_ITERATIONS }}
        run: |
          if [ "$EVENT_NAME" == "workflow_dispatch" ]; then
            echo "duration=$INPUT_DURATION" >> $GITHUB_OUTPUT
            echo "iterations=$INPUT_ITERATIONS" >> $GITHUB_OUTPUT
          else
            echo "duration=$DEFAULT_DURATION" >> $GITHUB_OUTPUT
            echo "iterations=$DEFAULT_ITERATIONS" >> $GITHUB_OUTPUT
          fi

      - name: Run nightly fuzzing campaign
        run: |
          mkdir -p ./corpus ./crashes ./output ./reports

          echo "[i] Starting nightly fuzzing campaign..."
          echo "[i] Iterations: ${{ steps.params.outputs.iterations }}"
          echo "[i] Start time: $(date -Iseconds)"

          # Create a template DICOM file
          uv run python -c "
          import pydicom
          from pydicom.dataset import Dataset, FileMetaDataset
          from pydicom.uid import generate_uid, ImplicitVRLittleEndian
          file_meta = FileMetaDataset()
          file_meta.TransferSyntaxUID = ImplicitVRLittleEndian
          file_meta.MediaStorageSOPClassUID = '1.2.840.10008.5.1.4.1.1.2'
          file_meta.MediaStorageSOPInstanceUID = generate_uid()
          file_meta.ImplementationClassUID = generate_uid()
          ds = Dataset()
          ds.file_meta = file_meta
          ds.is_implicit_VR = True
          ds.is_little_endian = True
          ds.PatientName = 'CI^Template'
          ds.PatientID = 'CI001'
          ds.Modality = 'CT'
          ds.Rows = 64
          ds.Columns = 64
          ds.BitsAllocated = 16
          ds.BitsStored = 16
          ds.HighBit = 15
          ds.SamplesPerPixel = 1
          ds.PixelRepresentation = 0
          ds.PhotometricInterpretation = 'MONOCHROME2'
          ds.PixelData = b'\x00' * (64 * 64 * 2)
          ds.save_as('./corpus/template.dcm', enforce_file_format=True)
          print('[+] Template created')
          "

          # Run mutation-based fuzzing
          uv run dicom-fuzzer ./corpus/template.dcm \
            -c ${{ steps.params.outputs.iterations }} \
            -o ./output \
            2>&1 | tee fuzz_output.log || true

          echo "[i] End time: $(date -Iseconds)"
          echo "[+] Nightly fuzzing completed"
        timeout-minutes: 490

      - name: Generate fuzzing report
        if: always()
        run: |
          echo "# Nightly Fuzzing Report" > ./reports/summary.md
          echo "" >> ./reports/summary.md
          echo "**Date**: $(date -I)" >> ./reports/summary.md
          echo "**Duration**: ${{ steps.params.outputs.duration }} seconds" >> ./reports/summary.md
          echo "**Iterations**: ${{ steps.params.outputs.iterations }}" >> ./reports/summary.md
          echo "" >> ./reports/summary.md

          CRASH_COUNT=$(find ./crashes -type f 2>/dev/null | wc -l)
          CORPUS_SIZE=$(find ./corpus -type f -name "*.dcm" 2>/dev/null | wc -l)

          echo "## Results" >> ./reports/summary.md
          echo "- Crashes found: $CRASH_COUNT" >> ./reports/summary.md
          echo "- Corpus size: $CORPUS_SIZE files" >> ./reports/summary.md
          echo "" >> ./reports/summary.md

          if [ "$CRASH_COUNT" -gt 0 ]; then
            echo "## Crash Files" >> ./reports/summary.md
            ls -la ./crashes/ >> ./reports/summary.md
          fi

          cat ./reports/summary.md

      - name: Upload fuzzing artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v5
        if: always()
        with:
          name: nightly-fuzzing-results-${{ github.run_number }}
          path: |
            ./crashes/
            ./reports/
            fuzz_output.log
          retention-days: 30

      - name: Update corpus cache
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb  # v4
        if: always()
        with:
          path: ./corpus
          key: fuzz-corpus-nightly-${{ github.run_number }}

  # CVE sample validation - ensures all CVE reproductions work
  cve-validation:
    name: CVE Sample Validation
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Install uv
        uses: astral-sh/setup-uv@374b9305c53f17cee51e793c1234cdb1897489d5  # v7
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Create template DICOM
        run: |
          uv run python -c "
          import pydicom
          from pydicom.dataset import Dataset, FileMetaDataset
          from pydicom.uid import generate_uid, ImplicitVRLittleEndian
          file_meta = FileMetaDataset()
          file_meta.TransferSyntaxUID = ImplicitVRLittleEndian
          file_meta.MediaStorageSOPClassUID = '1.2.840.10008.5.1.4.1.1.2'
          file_meta.MediaStorageSOPInstanceUID = generate_uid()
          file_meta.ImplementationClassUID = generate_uid()
          ds = Dataset()
          ds.file_meta = file_meta
          ds.is_implicit_VR = True
          ds.is_little_endian = True
          ds.PatientName = 'CVE^Template'
          ds.PatientID = 'CVE001'
          ds.Modality = 'CT'
          ds.Rows = 64
          ds.Columns = 64
          ds.BitsAllocated = 16
          ds.BitsStored = 16
          ds.HighBit = 15
          ds.SamplesPerPixel = 1
          ds.PixelRepresentation = 0
          ds.PhotometricInterpretation = 'MONOCHROME2'
          ds.PixelData = b'\x00' * (64 * 64 * 2)
          ds.save_as('./template.dcm', enforce_file_format=True)
          print('[+] Template created')
          "

      - name: Generate and validate CVE samples
        run: |
          mkdir -p ./cve_samples

          echo "[i] Listing available CVEs..."
          uv run dicom-fuzzer cve --list

          echo "[i] Generating all CVE reproduction samples..."
          uv run dicom-fuzzer cve --all -t ./template.dcm -o ./cve_samples

          CVE_COUNT=$(find ./cve_samples -name "*.dcm" | wc -l)
          echo "[+] Generated $CVE_COUNT CVE samples"

          if [ "$CVE_COUNT" -lt 10 ]; then
            echo "[-] FAIL: Expected at least 10 CVE samples, got $CVE_COUNT"
            exit 1
          fi

      - name: Upload CVE validation results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v5
        if: always()
        with:
          name: cve-validation-results
          path: ./cve_samples/
          retention-days: 14

  # CVE generator tests
  sample-generator-tests:
    name: Sample Generator Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Install uv
        uses: astral-sh/setup-uv@374b9305c53f17cee51e793c1234cdb1897489d5  # v7
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run CVE generator tests
        run: |
          uv run pytest tests/test_cve/ -v --tb=short --timeout=120
        timeout-minutes: 10

      - name: Run security tests
        run: |
          uv run pytest tests/ -k "security" -v --tb=short --timeout=60 || true
        timeout-minutes: 5

  fuzzing-summary:
    name: Fuzzing Summary
    if: always() && (github.event_name == 'pull_request' || github.event_name == 'schedule')
    runs-on: ubuntu-latest
    needs: [pr-sample-validation, pr-fuzzing, sample-generator-tests]
    steps:
      - name: Check fuzzing status
        run: |
          echo "=========================================="
          echo "           Fuzzing Pipeline Summary       "
          echo "=========================================="
          echo ""
          echo "Sample Validation: ${{ needs.pr-sample-validation.result || 'skipped' }}"
          echo "PR Fuzzing: ${{ needs.pr-fuzzing.result || 'skipped' }}"
          echo "Generator Tests: ${{ needs.sample-generator-tests.result }}"
          echo ""

          # Only fail on generator test failures (critical path)
          if [ "${{ needs.sample-generator-tests.result }}" == "failure" ]; then
            echo "[-] FAIL: Sample generator tests failed"
            exit 1
          fi

          echo "[+] Fuzzing pipeline completed"
