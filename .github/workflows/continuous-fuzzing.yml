# Continuous Fuzzing Workflow
# Runs fuzzing campaigns on schedule and PR to detect regressions
#
# Based on OSS-Fuzz and ClusterFuzz best practices
# Reference: https://google.github.io/oss-fuzz/

name: Continuous Fuzzing

on:
  # Run on schedule (nightly)
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily

  # Run on PRs that modify fuzzing-related code
  pull_request:
    paths:
      - 'harness/**'
      - 'dicom_fuzzer/core/parser.py'
      - 'dicom_fuzzer/core/mutator.py'
      - 'dicom_fuzzer/strategies/**'
      - '.github/workflows/continuous-fuzzing.yml'

  # Manual trigger
  workflow_dispatch:
    inputs:
      duration:
        description: 'Fuzzing duration in seconds'
        required: false
        default: '3600'
      fuzzer:
        description: 'Fuzzer to use (afl, libfuzzer, all)'
        required: false
        default: 'all'

env:
  FUZZ_DURATION: ${{ github.event.inputs.duration || '3600' }}

jobs:
  # Build fuzzing harnesses
  build-harnesses:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            afl++ \
            clang \
            llvm \
            libfuzzer-14-dev \
            python3-dev

      - name: Build AFL++ harness
        run: |
          cd harness
          afl-clang-fast -O2 -g \
            -fsanitize=address,undefined \
            -fno-omit-frame-pointer \
            -o dicom_harness_asan afl_persistent.c

      - name: Build AFL++ harness (no sanitizers)
        run: |
          cd harness
          afl-clang-fast -O2 -g \
            -o dicom_harness_fast afl_persistent.c

      - name: Build libFuzzer harness
        run: |
          cd harness
          clang++ -O1 -g \
            -fsanitize=fuzzer,address,undefined \
            -fno-omit-frame-pointer \
            -o dicom_libfuzzer libfuzzer_harness.cpp

      - name: Build custom mutator
        run: |
          cd harness/custom_mutators
          afl-clang-fast -shared -fPIC -O2 \
            -o dicom_mutator.so dicom_mutator.c

      - name: Upload harnesses
        uses: actions/upload-artifact@v4
        with:
          name: fuzzing-harnesses
          path: |
            harness/dicom_harness_asan
            harness/dicom_harness_fast
            harness/dicom_libfuzzer
            harness/custom_mutators/dicom_mutator.so
            harness/dicom.dict

  # AFL++ fuzzing with ASan
  fuzz-afl-asan:
    needs: build-harnesses
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - name: Install AFL++
        run: sudo apt-get update && sudo apt-get install -y afl++

      - name: Download harnesses
        uses: actions/download-artifact@v4
        with:
          name: fuzzing-harnesses
          path: harness/

      - name: Set permissions
        run: chmod +x harness/dicom_harness_asan

      - name: Prepare corpus
        run: |
          mkdir -p corpus
          # Copy seed files from samples
          cp -r samples/malicious_library/*.dcm corpus/ 2>/dev/null || true
          cp -r samples/cve_reproductions/*/*.dcm corpus/ 2>/dev/null || true
          # Generate minimal seeds if corpus is empty
          if [ -z "$(ls -A corpus)" ]; then
            python -c "
          import struct
          # Minimal valid DICOM
          preamble = b'\x00' * 128
          magic = b'DICM'
          # File Meta Information
          meta = b''
          # (0002,0000) FileMetaInformationGroupLength
          meta += struct.pack('<HHL', 0x0002, 0x0000, 4)
          meta += struct.pack('<L', 0)
          open('corpus/minimal.dcm', 'wb').write(preamble + magic + meta)
          "
          fi

      - name: Run AFL++ with ASan
        run: |
          export ASAN_OPTIONS="abort_on_error=1:symbolize=1:detect_leaks=0"
          export AFL_SKIP_CPUFREQ=1
          export AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES=1

          timeout ${{ env.FUZZ_DURATION }} afl-fuzz \
            -i corpus \
            -o findings_asan \
            -m 512 \
            -t 5000 \
            -x harness/dicom.dict \
            -- harness/dicom_harness_asan || true

      - name: Check for crashes
        id: check-crashes
        run: |
          if [ -d "findings_asan/default/crashes" ] && [ "$(ls -A findings_asan/default/crashes 2>/dev/null)" ]; then
            echo "crashes_found=true" >> $GITHUB_OUTPUT
            echo "[!] Crashes found!"
            ls -la findings_asan/default/crashes/
          else
            echo "crashes_found=false" >> $GITHUB_OUTPUT
            echo "[+] No crashes found"
          fi

      - name: Upload findings
        uses: actions/upload-artifact@v4
        with:
          name: afl-asan-findings
          path: findings_asan/

      - name: Fail if crashes found
        if: steps.check-crashes.outputs.crashes_found == 'true'
        run: |
          echo "::error::AFL++ ASan found crashes - review findings"
          exit 1

  # AFL++ fuzzing without sanitizers (faster)
  fuzz-afl-fast:
    needs: build-harnesses
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - name: Install AFL++
        run: sudo apt-get update && sudo apt-get install -y afl++

      - name: Download harnesses
        uses: actions/download-artifact@v4
        with:
          name: fuzzing-harnesses
          path: harness/

      - name: Set permissions
        run: chmod +x harness/dicom_harness_fast

      - name: Prepare corpus
        run: |
          mkdir -p corpus
          cp -r samples/malicious_library/*.dcm corpus/ 2>/dev/null || true
          cp -r samples/cve_reproductions/*/*.dcm corpus/ 2>/dev/null || true

      - name: Run AFL++ (fast mode)
        run: |
          export AFL_SKIP_CPUFREQ=1
          export AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES=1

          timeout ${{ env.FUZZ_DURATION }} afl-fuzz \
            -i corpus \
            -o findings_fast \
            -m 512 \
            -t 2000 \
            -x harness/dicom.dict \
            -- harness/dicom_harness_fast || true

      - name: Upload findings
        uses: actions/upload-artifact@v4
        with:
          name: afl-fast-findings
          path: findings_fast/

  # libFuzzer fuzzing
  fuzz-libfuzzer:
    needs: build-harnesses
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - name: Download harnesses
        uses: actions/download-artifact@v4
        with:
          name: fuzzing-harnesses
          path: harness/

      - name: Set permissions
        run: chmod +x harness/dicom_libfuzzer

      - name: Prepare corpus
        run: |
          mkdir -p corpus
          cp -r samples/malicious_library/*.dcm corpus/ 2>/dev/null || true
          cp -r samples/cve_reproductions/*/*.dcm corpus/ 2>/dev/null || true

      - name: Run libFuzzer
        run: |
          export ASAN_OPTIONS="abort_on_error=1:symbolize=1"

          mkdir -p findings_libfuzzer

          timeout ${{ env.FUZZ_DURATION }} harness/dicom_libfuzzer \
            corpus/ \
            -dict=harness/dicom.dict \
            -max_len=10485760 \
            -artifact_prefix=findings_libfuzzer/ \
            -print_final_stats=1 \
            2>&1 | tee libfuzzer.log || true

      - name: Check for crashes
        id: check-crashes
        run: |
          if ls findings_libfuzzer/crash-* 1>/dev/null 2>&1; then
            echo "crashes_found=true" >> $GITHUB_OUTPUT
            echo "[!] Crashes found!"
            ls -la findings_libfuzzer/crash-*
          else
            echo "crashes_found=false" >> $GITHUB_OUTPUT
            echo "[+] No crashes found"
          fi

      - name: Upload findings
        uses: actions/upload-artifact@v4
        with:
          name: libfuzzer-findings
          path: |
            findings_libfuzzer/
            libfuzzer.log

      - name: Fail if crashes found
        if: steps.check-crashes.outputs.crashes_found == 'true'
        run: |
          echo "::error::libFuzzer found crashes - review findings"
          exit 1

  # Coverage report generation
  coverage-report:
    needs: [fuzz-afl-asan, fuzz-afl-fast, fuzz-libfuzzer]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Download all findings
        uses: actions/download-artifact@v4
        with:
          path: all-findings/

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov llvm

      - name: Generate coverage summary
        run: |
          echo "# Fuzzing Coverage Report" > coverage_report.md
          echo "" >> coverage_report.md
          echo "Generated: $(date -u)" >> coverage_report.md
          echo "" >> coverage_report.md

          # AFL ASan stats
          if [ -f "all-findings/afl-asan-findings/default/fuzzer_stats" ]; then
            echo "## AFL++ (ASan)" >> coverage_report.md
            echo '```' >> coverage_report.md
            grep -E "(execs_done|execs_per_sec|corpus_count|saved_crashes)" \
              all-findings/afl-asan-findings/default/fuzzer_stats >> coverage_report.md
            echo '```' >> coverage_report.md
          fi

          # AFL Fast stats
          if [ -f "all-findings/afl-fast-findings/default/fuzzer_stats" ]; then
            echo "## AFL++ (Fast)" >> coverage_report.md
            echo '```' >> coverage_report.md
            grep -E "(execs_done|execs_per_sec|corpus_count|saved_crashes)" \
              all-findings/afl-fast-findings/default/fuzzer_stats >> coverage_report.md
            echo '```' >> coverage_report.md
          fi

          # libFuzzer stats
          if [ -f "all-findings/libfuzzer-findings/libfuzzer.log" ]; then
            echo "## libFuzzer" >> coverage_report.md
            echo '```' >> coverage_report.md
            tail -20 all-findings/libfuzzer-findings/libfuzzer.log >> coverage_report.md
            echo '```' >> coverage_report.md
          fi

          cat coverage_report.md

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage_report.md

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('coverage_report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  # Crash triage and deduplication
  triage-crashes:
    needs: [fuzz-afl-asan, fuzz-libfuzzer]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -e .
          sudo apt-get update
          sudo apt-get install -y afl++

      - name: Download findings
        uses: actions/download-artifact@v4
        with:
          path: all-findings/

      - name: Triage crashes
        run: |
          python -c "
          import json
          import hashlib
          from pathlib import Path

          crashes = []
          seen_hashes = set()

          # Collect crashes from all fuzzers
          for crash_dir in Path('all-findings').rglob('crash*'):
              if crash_dir.is_file():
                  data = crash_dir.read_bytes()
                  h = hashlib.sha256(data).hexdigest()[:16]

                  if h not in seen_hashes:
                      seen_hashes.add(h)
                      crashes.append({
                          'file': str(crash_dir),
                          'hash': h,
                          'size': len(data),
                          'fuzzer': crash_dir.parts[1] if len(crash_dir.parts) > 1 else 'unknown'
                      })

          # Write deduplicated crash report
          report = {
              'total_crashes': len(crashes),
              'unique_crashes': len(seen_hashes),
              'crashes': crashes
          }

          with open('crash_report.json', 'w') as f:
              json.dump(report, f, indent=2)

          print(f'Total crashes: {len(crashes)}')
          print(f'Unique crashes: {len(seen_hashes)}')
          "

      - name: Upload crash report
        uses: actions/upload-artifact@v4
        with:
          name: crash-triage-report
          path: crash_report.json

      - name: Create issue for crashes
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('crash_report.json', 'utf8'));

            if (report.unique_crashes > 0) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Fuzzing] ${report.unique_crashes} unique crashes found`,
                body: `## Fuzzing Report\n\nTotal crashes: ${report.total_crashes}\nUnique crashes: ${report.unique_crashes}\n\nSee artifacts for details.`,
                labels: ['security', 'fuzzing', 'bug']
              });
            }
