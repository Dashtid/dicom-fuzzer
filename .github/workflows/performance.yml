name: Performance Monitoring

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

# Optimize concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # NOTE: benchmark job removed - no benchmark tests exist in test suite
  # Add pytest-benchmark tests before re-enabling this job

  memory-profiling:
    name: Memory Profiling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Install uv
        uses: astral-sh/setup-uv@374b9305c53f17cee51e793c1234cdb1897489d5  # v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: |
          uv sync --all-extras
          uv pip install memory-profiler matplotlib

      - name: Profile memory usage
        run: |
          # Create memory profiling script
          cat > profile_memory.py << 'EOF'
          import tempfile
          from pathlib import Path
          from memory_profiler import profile
          from pydicom.dataset import Dataset, FileMetaDataset, FileDataset
          from pydicom.uid import generate_uid
          from dicom_fuzzer.core.parser import DicomParser
          from dicom_fuzzer.core.mutator import DicomMutator

          def create_test_dicom_file():
              """Create a minimal DICOM file for testing."""
              # Create temp file
              temp_dir = tempfile.mkdtemp()
              temp_path = Path(temp_dir) / "test.dcm"

              # Create file meta
              file_meta = FileMetaDataset()
              file_meta.MediaStorageSOPClassUID = "1.2.840.10008.5.1.4.1.1.2"
              file_meta.MediaStorageSOPInstanceUID = generate_uid()
              file_meta.TransferSyntaxUID = "1.2.840.10008.1.2"
              file_meta.ImplementationClassUID = generate_uid()

              # Create dataset
              ds = FileDataset(str(temp_path), {}, file_meta=file_meta, preamble=b"\x00" * 128)
              ds.SOPClassUID = file_meta.MediaStorageSOPClassUID
              ds.SOPInstanceUID = file_meta.MediaStorageSOPInstanceUID
              ds.PatientName = "TEST^PATIENT"
              ds.PatientID = "12345"
              ds.Modality = "CT"
              ds.Rows = 64
              ds.Columns = 64
              ds.BitsAllocated = 16
              ds.BitsStored = 16
              ds.HighBit = 15
              ds.PixelRepresentation = 0
              ds.SamplesPerPixel = 1
              ds.PhotometricInterpretation = "MONOCHROME2"
              ds.PixelData = b"\x00" * (64 * 64 * 2)

              # Save to file
              ds.save_as(str(temp_path), write_like_original=False)
              return temp_path, ds

          @profile
          def test_parser_memory():
              """Profile DICOM parser memory usage."""
              temp_path, _ = create_test_dicom_file()
              parser = DicomParser(str(temp_path))
              metadata = parser.extract_metadata()
              return metadata

          @profile
          def test_mutator_memory():
              """Profile DICOM mutator memory usage."""
              _, dataset = create_test_dicom_file()
              mutator = DicomMutator()
              mutator.start_session(dataset)
              for _ in range(100):
                  mutated = mutator.apply_mutations(dataset, num_mutations=5)
              return mutated

          if __name__ == '__main__':
              print("Memory profiling DICOM parser...")
              test_parser_memory()
              print("\nMemory profiling DICOM mutator...")
              test_mutator_memory()
          EOF

          uv run python -m memory_profiler profile_memory.py > memory-profile.txt

      - name: Upload memory profile
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v5
        with:
          name: memory-profile
          path: memory-profile.txt

  # NOTE: load-testing job removed - Locust is for HTTP API load testing,
  # not useful for CLI tools. Re-enable if adding a REST API.

  cpu-profiling:
    name: CPU Profiling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Install uv
        uses: astral-sh/setup-uv@374b9305c53f17cee51e793c1234cdb1897489d5  # v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: |
          uv sync --all-extras
          uv pip install py-spy

      - name: CPU profiling with py-spy
        run: |
          # Create profiling script
          cat > cpu_profile.py << 'EOF'
          from pydicom.dataset import Dataset, FileMetaDataset
          from pydicom.uid import generate_uid
          from dicom_fuzzer.core.mutator import DicomMutator

          def create_test_dataset():
              """Create a minimal DICOM dataset for testing."""
              ds = Dataset()
              ds.file_meta = FileMetaDataset()
              ds.file_meta.MediaStorageSOPClassUID = "1.2.840.10008.5.1.4.1.1.2"
              ds.file_meta.MediaStorageSOPInstanceUID = generate_uid()
              ds.file_meta.TransferSyntaxUID = "1.2.840.10008.1.2"
              ds.SOPClassUID = ds.file_meta.MediaStorageSOPClassUID
              ds.SOPInstanceUID = ds.file_meta.MediaStorageSOPInstanceUID
              ds.PatientName = "TEST^PATIENT"
              ds.PatientID = "12345"
              ds.Modality = "CT"
              ds.Rows = 64
              ds.Columns = 64
              ds.BitsAllocated = 16
              ds.BitsStored = 16
              ds.HighBit = 15
              ds.PixelRepresentation = 0
              ds.SamplesPerPixel = 1
              ds.PhotometricInterpretation = "MONOCHROME2"
              ds.PixelData = b"\x00" * (64 * 64 * 2)
              return ds

          def main():
              mutator = DicomMutator()

              for _ in range(1000):
                  dataset = create_test_dataset()
                  mutator.start_session(dataset)
                  mutated = mutator.apply_mutations(dataset, num_mutations=10)

          if __name__ == '__main__':
              main()
          EOF

          # py-spy may exit with non-zero when the profiled process exits
          # Use || true to handle this gracefully
          uv run py-spy record -o cpu-profile.svg --format speedscope -- python cpu_profile.py || true
          # Verify profile was created
          if [ -f cpu-profile.svg ]; then
            echo "CPU profile created successfully"
          else
            echo "Warning: CPU profile not created, creating empty placeholder"
            echo '<svg></svg>' > cpu-profile.svg
          fi

      - name: Upload CPU profile
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v5
        with:
          name: cpu-profile
          path: cpu-profile.svg

  performance-summary:
    name: Performance Summary
    runs-on: ubuntu-latest
    needs: [memory-profiling, cpu-profiling]
    if: always()
    steps:
      - name: Check performance status
        run: |
          echo "Performance Monitoring Summary"
          echo "=============================="
          echo "Memory Profiling: ${{ needs.memory-profiling.result }}"
          echo "CPU Profiling: ${{ needs.cpu-profiling.result }}"

          echo "Performance monitoring completed!"
