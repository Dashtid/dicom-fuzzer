"""CVE-Inspired Mutation Strategies.

Vulnerability-guided fuzzing (Directed Greybox Fuzzing) for DICOM parsers.

These mutations generate malformed DICOM test files based on known CVE patterns.
This is FUZZING, not penetration testing:
- Fuzzing: "Does my parser have similar bugs?" (generates test cases)
- Pentesting: "Can I exploit this CVE?" (attacks running systems)

The CVE patterns guide the fuzzer toward known vulnerability classes, making it
more effective at finding similar bugs in YOUR software. This approach is
recommended by FDA guidance (2025) for medical device security testing.

CVEs Covered (26 total mutations across 20 CVEs):

2025 CVEs:
- CVE-2025-5943: MicroDicom heap buffer overflow in pixel data parsing
- CVE-2025-35975: MicroDicom out-of-bounds write (June 2025)
- CVE-2025-11266: GDCM out-of-bounds write in encapsulated PixelData fragments
- CVE-2025-53618: GDCM JPEG codec out-of-bounds read (info leak)
- CVE-2025-53619: GDCM JPEG codec out-of-bounds read
- CVE-2025-1001: RadiAnt DICOM Viewer certificate validation bypass (MITM)
- CVE-2025-27578: OsiriX MD use-after-free via DICOM upload
- CVE-2025-31946: OsiriX MD local use-after-free via DICOM import
- CVE-2025-5307: Sante DICOM Viewer Pro out-of-bounds read

2024 CVEs:
- CVE-2024-22100: MicroDicom heap-based buffer overflow
- CVE-2024-25578: MicroDicom out-of-bounds write (lack of validation)
- CVE-2024-28877: MicroDicom stack-based buffer overflow
- CVE-2024-33606: MicroDicom URL scheme bypass
- CVE-2024-1453: Sante DICOM Viewer Pro out-of-bounds read
- CVE-2024-47796: DCMTK out-of-bounds write in nowindow LUT (TALOS-2024-2122)
- CVE-2024-52333: DCMTK out-of-bounds write in determineMinMax (TALOS-2024-2121)

Legacy CVEs:
- CVE-2019-11687: DICOM preamble polyglot (PE/DICOM, ELF/DICOM)
- CVE-2020-29625: DCMTK denial of service via malformed length fields
- CVE-2021-41946: ClearCanvas path traversal via filename injection
- CVE-2022-24193: OsiriX denial of service via deep nesting

References:
- CISA ICS-CERT Medical Advisories (ICSMA-24-058-01, ICSMA-24-060-01,
  ICSMA-25-037-01, ICSMA-25-051-01, ICSMA-25-128-01, ICSMA-25-160-01,
  ICSMA-25-345-01)
- NIST NVD DICOM entries
- OWASP Medical Device Security

"""

from __future__ import annotations

import random
from typing import Any

# Import base types
from .cve_mutations_base import CVECategory, CVEMutation

# Import memory corruption mutations
from .cve_mutations_memory import (
    mutate_dcmtk_determine_minmax_oob,
    mutate_dcmtk_nowindow_oob_write,
    mutate_heap_overflow_dcm_parsing,
    mutate_heap_overflow_pixel_data,
    mutate_integer_overflow_dimensions,
    mutate_oob_read_sante_2024,
    mutate_oob_read_sante_2025,
    mutate_oob_write_lack_validation,
    mutate_oob_write_pixel_data,
    mutate_stack_overflow_dcm,
)

# Import protocol and parser mutations
from .cve_mutations_protocol import (
    mutate_certificate_validation_bypass,
    mutate_deep_nesting,
    mutate_elf_polyglot_preamble,
    mutate_encapsulated_pixeldata_underflow,
    mutate_fragment_count_mismatch,
    mutate_invalid_transfer_syntax,
    mutate_jpeg_codec_oob_read,
    mutate_jpeg_truncated_stream,
    mutate_malformed_length_field,
    mutate_oversized_length,
    mutate_path_traversal_filename,
    mutate_pe_polyglot_preamble,
    mutate_url_scheme_bypass,
    mutate_use_after_free_local,
    mutate_use_after_free_remote,
)

# Registry of all CVE mutations
CVE_MUTATIONS: list[CVEMutation] = [
    CVEMutation(
        cve_id="CVE-2025-5943",
        category=CVECategory.HEAP_OVERFLOW,
        description="MicroDicom heap buffer overflow in pixel data parsing",
        mutation_func="mutate_heap_overflow_pixel_data",
        severity="critical",
        target_component="pixel_data",
    ),
    CVEMutation(
        cve_id="CVE-2025-5943",
        category=CVECategory.INTEGER_OVERFLOW,
        description="Integer overflow in dimension calculation",
        mutation_func="mutate_integer_overflow_dimensions",
        severity="critical",
        target_component="image_dimensions",
    ),
    CVEMutation(
        cve_id="CVE-2020-29625",
        category=CVECategory.MALFORMED_LENGTH,
        description="DCMTK DoS via undefined length fields",
        mutation_func="mutate_malformed_length_field",
        severity="high",
        target_component="vr_length",
    ),
    CVEMutation(
        cve_id="CVE-2020-29625",
        category=CVECategory.MALFORMED_LENGTH,
        description="Length larger than remaining file",
        mutation_func="mutate_oversized_length",
        severity="high",
        target_component="vr_length",
    ),
    CVEMutation(
        cve_id="CVE-2021-41946",
        category=CVECategory.PATH_TRAVERSAL,
        description="ClearCanvas path traversal via filename injection",
        mutation_func="mutate_path_traversal_filename",
        severity="high",
        target_component="referenced_file",
    ),
    CVEMutation(
        cve_id="CVE-2022-24193",
        category=CVECategory.DEEP_NESTING,
        description="OsiriX DoS via deep sequence nesting",
        mutation_func="mutate_deep_nesting",
        severity="medium",
        target_component="sequence",
    ),
    CVEMutation(
        cve_id="CVE-2019-11687",
        category=CVECategory.POLYGLOT,
        description="PE/DICOM polyglot in preamble",
        mutation_func="mutate_pe_polyglot_preamble",
        severity="critical",
        target_component="preamble",
    ),
    CVEMutation(
        cve_id="CVE-2019-11687",
        category=CVECategory.POLYGLOT,
        description="ELF/DICOM polyglot in preamble",
        mutation_func="mutate_elf_polyglot_preamble",
        severity="critical",
        target_component="preamble",
    ),
    CVEMutation(
        cve_id="GENERIC",
        category=CVECategory.BUFFER_OVERFLOW,
        description="Invalid transfer syntax UID injection",
        mutation_func="mutate_invalid_transfer_syntax",
        severity="medium",
        target_component="transfer_syntax",
    ),
    # CVE-2025-11266: GDCM encapsulated PixelData vulnerabilities
    CVEMutation(
        cve_id="CVE-2025-11266",
        category=CVECategory.INTEGER_UNDERFLOW,
        description="GDCM integer underflow in encapsulated PixelData fragments",
        mutation_func="mutate_encapsulated_pixeldata_underflow",
        severity="high",
        target_component="encapsulated_pixel_data",
    ),
    CVEMutation(
        cve_id="CVE-2025-11266",
        category=CVECategory.ENCAPSULATED_PIXEL,
        description="Fragment count mismatch in offset table",
        mutation_func="mutate_fragment_count_mismatch",
        severity="high",
        target_component="encapsulated_pixel_data",
    ),
    # CVE-2025-53618/53619: GDCM JPEG codec vulnerabilities
    CVEMutation(
        cve_id="CVE-2025-53618",
        category=CVECategory.OUT_OF_BOUNDS_READ,
        description="GDCM JPEG codec OOB read via malformed Huffman tables",
        mutation_func="mutate_jpeg_codec_oob_read",
        severity="high",
        target_component="jpeg_codec",
    ),
    CVEMutation(
        cve_id="CVE-2025-53619",
        category=CVECategory.JPEG_CODEC,
        description="JPEG stream truncation causing OOB read",
        mutation_func="mutate_jpeg_truncated_stream",
        severity="high",
        target_component="jpeg_codec",
    ),
    # CVE-2025-35975: MicroDicom Out-of-Bounds Write
    CVEMutation(
        cve_id="CVE-2025-35975",
        category=CVECategory.OUT_OF_BOUNDS_WRITE,
        description="MicroDicom OOB write via pixel data dimension mismatch",
        mutation_func="mutate_oob_write_pixel_data",
        severity="critical",
        target_component="pixel_data",
    ),
    # CVE-2024-25578: MicroDicom Out-of-Bounds Write
    CVEMutation(
        cve_id="CVE-2024-25578",
        category=CVECategory.OUT_OF_BOUNDS_WRITE,
        description="MicroDicom OOB write due to lack of validation",
        mutation_func="mutate_oob_write_lack_validation",
        severity="high",
        target_component="vr_length",
    ),
    # CVE-2024-22100: MicroDicom Heap Buffer Overflow
    CVEMutation(
        cve_id="CVE-2024-22100",
        category=CVECategory.HEAP_OVERFLOW,
        description="MicroDicom heap overflow in DCM parsing",
        mutation_func="mutate_heap_overflow_dcm_parsing",
        severity="critical",
        target_component="private_elements",
    ),
    # CVE-2024-28877: MicroDicom Stack Buffer Overflow
    CVEMutation(
        cve_id="CVE-2024-28877",
        category=CVECategory.STACK_OVERFLOW,
        description="MicroDicom stack overflow via nested structures",
        mutation_func="mutate_stack_overflow_dcm",
        severity="critical",
        target_component="sequence",
    ),
    # CVE-2024-33606: MicroDicom URL Scheme Bypass
    CVEMutation(
        cve_id="CVE-2024-33606",
        category=CVECategory.URL_SCHEME_BYPASS,
        description="MicroDicom URL scheme security bypass",
        mutation_func="mutate_url_scheme_bypass",
        severity="high",
        target_component="url_elements",
    ),
    # CVE-2025-1001: RadiAnt Certificate Validation Bypass
    CVEMutation(
        cve_id="CVE-2025-1001",
        category=CVECategory.CERTIFICATE_VALIDATION,
        description="RadiAnt certificate validation bypass (MITM)",
        mutation_func="mutate_certificate_validation_bypass",
        severity="medium",
        target_component="metadata",
    ),
    # CVE-2025-27578: OsiriX MD Use-After-Free (Remote)
    CVEMutation(
        cve_id="CVE-2025-27578",
        category=CVECategory.USE_AFTER_FREE,
        description="OsiriX MD use-after-free via DICOM upload",
        mutation_func="mutate_use_after_free_remote",
        severity="critical",
        target_component="sequence",
    ),
    # CVE-2025-31946: OsiriX MD Use-After-Free (Local)
    CVEMutation(
        cve_id="CVE-2025-31946",
        category=CVECategory.USE_AFTER_FREE,
        description="OsiriX MD local use-after-free via import",
        mutation_func="mutate_use_after_free_local",
        severity="high",
        target_component="pixel_data",
    ),
    # CVE-2024-1453: Sante DICOM Viewer Pro OOB Read
    CVEMutation(
        cve_id="CVE-2024-1453",
        category=CVECategory.OUT_OF_BOUNDS_READ,
        description="Sante DICOM Viewer Pro OOB read (2024)",
        mutation_func="mutate_oob_read_sante_2024",
        severity="high",
        target_component="string_elements",
    ),
    # CVE-2025-5307: Sante DICOM Viewer Pro OOB Read (2025)
    CVEMutation(
        cve_id="CVE-2025-5307",
        category=CVECategory.OUT_OF_BOUNDS_READ,
        description="Sante DICOM Viewer Pro OOB read (2025)",
        mutation_func="mutate_oob_read_sante_2025",
        severity="high",
        target_component="pixel_data",
    ),
    # CVE-2024-47796: DCMTK nowindow LUT OOB Write
    CVEMutation(
        cve_id="CVE-2024-47796",
        category=CVECategory.OUT_OF_BOUNDS_WRITE,
        description="DCMTK OOB write in nowindow LUT processing",
        mutation_func="mutate_dcmtk_nowindow_oob_write",
        severity="critical",
        target_component="lut_data",
    ),
    # CVE-2024-52333: DCMTK determineMinMax OOB Write
    CVEMutation(
        cve_id="CVE-2024-52333",
        category=CVECategory.OUT_OF_BOUNDS_WRITE,
        description="DCMTK OOB write in determineMinMax",
        mutation_func="mutate_dcmtk_determine_minmax_oob",
        severity="critical",
        target_component="pixel_data",
    ),
]

# Build function lookup table from imported functions
_MUTATION_FUNCS = {
    # Memory mutations
    "mutate_heap_overflow_pixel_data": mutate_heap_overflow_pixel_data,
    "mutate_integer_overflow_dimensions": mutate_integer_overflow_dimensions,
    "mutate_oob_write_pixel_data": mutate_oob_write_pixel_data,
    "mutate_oob_write_lack_validation": mutate_oob_write_lack_validation,
    "mutate_heap_overflow_dcm_parsing": mutate_heap_overflow_dcm_parsing,
    "mutate_stack_overflow_dcm": mutate_stack_overflow_dcm,
    "mutate_oob_read_sante_2024": mutate_oob_read_sante_2024,
    "mutate_oob_read_sante_2025": mutate_oob_read_sante_2025,
    "mutate_dcmtk_nowindow_oob_write": mutate_dcmtk_nowindow_oob_write,
    "mutate_dcmtk_determine_minmax_oob": mutate_dcmtk_determine_minmax_oob,
    # Protocol mutations
    "mutate_malformed_length_field": mutate_malformed_length_field,
    "mutate_oversized_length": mutate_oversized_length,
    "mutate_path_traversal_filename": mutate_path_traversal_filename,
    "mutate_deep_nesting": mutate_deep_nesting,
    "mutate_pe_polyglot_preamble": mutate_pe_polyglot_preamble,
    "mutate_elf_polyglot_preamble": mutate_elf_polyglot_preamble,
    "mutate_invalid_transfer_syntax": mutate_invalid_transfer_syntax,
    "mutate_encapsulated_pixeldata_underflow": mutate_encapsulated_pixeldata_underflow,
    "mutate_fragment_count_mismatch": mutate_fragment_count_mismatch,
    "mutate_jpeg_codec_oob_read": mutate_jpeg_codec_oob_read,
    "mutate_jpeg_truncated_stream": mutate_jpeg_truncated_stream,
    "mutate_url_scheme_bypass": mutate_url_scheme_bypass,
    "mutate_certificate_validation_bypass": mutate_certificate_validation_bypass,
    "mutate_use_after_free_remote": mutate_use_after_free_remote,
    "mutate_use_after_free_local": mutate_use_after_free_local,
}


def get_mutation_func(name: str) -> Any:
    """Get mutation function by name."""
    return _MUTATION_FUNCS.get(name)


def apply_cve_mutation(
    data: bytes, cve_id: str | None = None
) -> tuple[bytes, CVEMutation]:
    """Apply a CVE-inspired mutation to DICOM data.

    Args:
        data: Original DICOM bytes
        cve_id: Optional specific CVE to target

    Returns:
        Tuple of (mutated_data, mutation_info)

    """
    if cve_id:
        mutations = [m for m in CVE_MUTATIONS if m.cve_id == cve_id]
        if not mutations:
            raise ValueError(f"Unknown CVE: {cve_id}")
    else:
        mutations = CVE_MUTATIONS

    mutation = random.choice(mutations)
    func = get_mutation_func(mutation.mutation_func)

    if func is None:
        raise ValueError(f"Mutation function not found: {mutation.mutation_func}")

    mutated_data = func(data)
    return mutated_data, mutation


def get_available_cves() -> list[str]:
    """Get list of available CVE IDs."""
    return list({m.cve_id for m in CVE_MUTATIONS})


def get_mutations_by_category(category: CVECategory) -> list[CVEMutation]:
    """Get mutations by category."""
    return [m for m in CVE_MUTATIONS if m.category == category]


# Re-export all public symbols for backward compatibility
__all__ = [
    # Types
    "CVECategory",
    "CVEMutation",
    # Registry
    "CVE_MUTATIONS",
    # Helper functions
    "get_mutation_func",
    "apply_cve_mutation",
    "get_available_cves",
    "get_mutations_by_category",
    # Memory mutation functions
    "mutate_heap_overflow_pixel_data",
    "mutate_integer_overflow_dimensions",
    "mutate_oob_write_pixel_data",
    "mutate_oob_write_lack_validation",
    "mutate_heap_overflow_dcm_parsing",
    "mutate_stack_overflow_dcm",
    "mutate_oob_read_sante_2024",
    "mutate_oob_read_sante_2025",
    "mutate_dcmtk_nowindow_oob_write",
    "mutate_dcmtk_determine_minmax_oob",
    # Protocol mutation functions
    "mutate_malformed_length_field",
    "mutate_oversized_length",
    "mutate_path_traversal_filename",
    "mutate_deep_nesting",
    "mutate_pe_polyglot_preamble",
    "mutate_elf_polyglot_preamble",
    "mutate_invalid_transfer_syntax",
    "mutate_encapsulated_pixeldata_underflow",
    "mutate_fragment_count_mismatch",
    "mutate_jpeg_codec_oob_read",
    "mutate_jpeg_truncated_stream",
    "mutate_url_scheme_bypass",
    "mutate_certificate_validation_bypass",
    "mutate_use_after_free_remote",
    "mutate_use_after_free_local",
]
